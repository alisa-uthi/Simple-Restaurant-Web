<%- include('./index') %> 
<div>
    <div>
        <h5>Table <%= tables[0].id %></h5>
    </div>
    <form action="/ordered-food/<%= tables[0].id %>/order" method="POST">
        <div>
            <table>
                <tr>
                    <th>Food Menu</th>
                    <th>Unit Price</th>
                    <th>Quantity</th>
                    <th>Total</th>
                </tr>
                <% foods.forEach(food => { %>
                    <tr class="menu-row">
                        <td><%= food.name %></td>
                        <td class="price"><%= food.price %></td>
                        <td><input type="number" class="quantity" min="0" name="<%= food.name %>"
                            onkeydown="javascript: return event.keyCode === 8 ||
                                event.keyCode === 46 ? true : !isNaN(Number(event.key))" 
                            oninput="quantityChanged()"></td>
                        <td class="each-menu-total-price">0.00</td>
                    </tr>
                <% }) %> 
                <tr>
                    <th>Drink Menu</th>
                    <th>Unit Price</th>
                    <th>Quantity</th>
                    <th>Total</th>
                </tr>
                
                <% drinks.forEach(drink => { %>  
                    <tr class="menu-row">
                        <td><%= drink.name %></td>
                        <td class="price"><%= drink.price %></td>
                        <td><input type="number" class="quantity" min="0" name="<%= drink.name %>"
                            onkeydown="javascript: return event.keyCode === 8 ||
                                event.keyCode === 46 ? true : !isNaN(Number(event.key))"
                            oninput="quantityChanged()"></td>
                        <td class="each-menu-total-price">0.00</td>
                    </tr>
                <% }) %>  
                <tr>
                    <th>TOTAL</th>
                    <th></th>
                    <th class="total-quantity">0</th>
                    <th class="total-price">0.00</th>
                </tr>  
            </table>
        </div>
        <div>
            <button type="reset" name="calcel-order-btn" id="calcel-order-btn">Cancel</button>
            <button type="submit" name="confirm-order-btn" id="confirm-order-btn">Confirm</button>
            <button type="button" name="check-bill-btn" id="check-bill-btn">Check Bill</button>
        </div>
    </form>
</div>
<script>
    if(document.readyState == "loading"){
        document.addEventListener('DOMContentLoaded', quantityChanged)
    }else{
        quantityChanged()
    }

    function quantityChanged(){
        var quantityElements = document.getElementsByClassName('quantity')
        quantityElements.addEventListener('change', calculateEachMenuPrice(event))
    }

    function calculateEachMenuPrice(event){
        var input = event.target
        if(isNaN(input.value)){
            input.value = 0
        }
        updateEachTotalPrice(input)
    }

    function updateEachTotalPrice(inputQuantityElement){
        var RowElement = inputQuantityElement.parentElement.parentElement
        var quantity = inputQuantityElement.value
        var unitPriceElement = RowElement.getElementsByClassName('price')[0]
        var unitPrice = parseFloat(unitPriceElement.textContent)
        var eachTotalPrice = unitPrice * quantity
        var eachTotalElement = RowElement.getElementsByClassName('each-menu-total-price')[0]
        eachTotalElement.innerText = parseFloat(eachTotalPrice).toFixed(2)
        updateTotalPrice()
    }

    var listOfOrder = []
    
    function updateTotalPrice(){
        var menusRowElement = document.getElementsByClassName('menu-row')
        var totalQuantity = 0
        var totalPrice = 0
        for(var i = 0; i < menusRowElement.length; i++){
            var menusRow = menusRowElement[i]
            var quantityElement = menusRow.getElementsByClassName('quantity')[0]
            var quantity = quantityElement.value
            var menuName = quantityElement.getAttribute('name')
            var unitPriceElement = menusRow.getElementsByClassName('price')[0]
            var unitPrice = parseFloat(unitPriceElement.textContent)
            var eachTotalPrice = unitPrice * quantity
            totalPrice += eachTotalPrice
            totalQuantity = parseFloat(totalQuantity) + (quantity * 1)
            
            if(eachTotalPrice > 0){
                listOfOrder.push({
                    name: menuName,
                    quantity: quantity,
                })
            }
        }
        document.getElementsByClassName('total-quantity')[0].innerHTML = totalQuantity
        document.getElementsByClassName('total-price')[0].innerHTML = totalPrice.toFixed(2)
    }

    $(document).ready(function(){
        console.log(listOfOrder[0])

        $('#confirm-order-btn').click(function() {

            $.post(`/ordered-food/${table_id}/order`, {
                listOfOrder: JSON.stringify(listOfOrder)
            })
        })
    })
</script>